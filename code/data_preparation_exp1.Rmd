---
title: "Data preparation"
output: html_notebook
---

# Load required packages 
```{r warning=FALSE}
library("stringr")
library("readr")
library(tidyverse)
library(RColorBrewer)
library(ggpubr)

```
# Temporary solution

```{r}
source(here::here("code","read_bids.R"))

# Initialize parameters
projdir <- "/Users/au342995/Documents/MINDLAB2022_CalibrationTGI" ### TO UPDATE
sub <- 1:27
ses <- 1:2
dat <- "beh"
save <- TRUE

# Define input parameters
tasks <- c("fastEst", "fastTrl", "psi", "vas")

# Initialize empty dataframe to store results
df_avail <- data.frame(sub = numeric(), ses = numeric(), stringsAsFactors = FALSE)

# Loop over all tasks
for (task in tasks) {
  
  # Import data for all participants and sessions
  df_task <- read_bids(projdir, sub, ses, task, dat, save)
  
  # Count number of available files for each participant and session
  avail_counts <- as.data.frame(table(df_task$sub, df_task$ses))
  names(avail_counts) <- c("sub", "ses", task)
  
  # Merge with results dataframe
  df_avail <- merge(df_avail, avail_counts, all = TRUE)
}

# Replace NA values with 0
df_avail[is.na(df_avail)] <- 0

# Print results
print(df_avail)

```

# VAS: Check the number of trials
```{r}
library(dplyr)

df_summary <- df_avail %>%
  filter(ses %in% c(1,2)) %>%
  group_by(ses) %>%
  summarize(total = length(unique(sub[ses==ses])),
            all_405 = sum(vas == 405), 
            not_all = sum(vas < 405),
            from200_to405 = sum(vas > 200 & vas < 405), 
            from100_to200 = sum(vas > 100 & vas <= 200), 
            none = sum(vas == 0))

df_summary

```
# VAS: summary 
```{r}
# Load vas data
vas <- read.csv(here::here("data", "vas.csv"), header = TRUE)

# Calculate median of VAS ratings and VAS response times
vas_temps <- vas %>%
  group_by(sub, ses, threshold, gain, stim_type, vas_type) %>%
  summarize(temp_cold = mean(target_cold_t1), temp_warm = mean(target_warm_t1))

vas_ratings <- vas %>%
  group_by(sub, ses, threshold, gain, stim_type, vas_type) %>%
  summarize(vas_rating_median = median(vas_rating), vas_rt_median = median(vas_rt))

df_vas <- inner_join(vas_temps, vas_ratings, by = c('sub', 'ses', 'threshold', 'gain', 'stim_type', 'vas_type'))
df_vas
```
# Thresholds: summary
Define threshold function data and restrict data to TGI range (i.e., all data points below CPT and above HPT are defined as NA)
```{r warning=FALSE}
# Load fast and psi threshold data
fe <- read.csv(here::here("data", "fastEst.csv"), header = TRUE)
psi <- read.csv(here::here("data", "psi.csv"), header = TRUE)

sublist <- unique(fe$sub)
seslist <- c(1,2)

# Psi thresholds: Select the last row with non-NA data
df_psi <- psi %>%
  group_by(sub, ses, quality) %>%
  filter((quality == "warm" & !is.na(threshold)) | (quality == "cold" & !is.na(threshold))) %>%
  slice(n())
df_psi

# Fast thresholds
df_fe <- crossing(sublist, seslist) %>%
  pmap_dfr(function(sublist, seslist) {
    psi_sub <- df_psi %>% filter(sub == sublist & ses == seslist) # define CPT and HPT for one participant
    cpt <- psi_sub %>% filter(quality == 'cold')
    hpt <- psi_sub %>% filter(quality == 'warm')
    fe_sub <- fe %>% filter(sub == sublist & ses == seslist) # define data for each subject
    fe_sub$temp_cold_na <- fe_sub$temp_cold # copy temp cold_column
    fe_sub$temp_cold_na[fe_sub$temp_cold < cpt$threshold | fe_sub$temp_warm > hpt$threshold] <- NA # remove data below CPT and above HPT
    fe_sub
  })
df_fe


```

# Plot data for each participant
```{r warning=FALSE}
source(here::here('code','plotFast_v1.R'))

sublist <- unique(fe$sub)

walk(sublist, function(sub_n) {
  plots <- list()
     
  substr <- paste0('sub-', str_pad(sub_n, 4, pad = '0'))
    
  # Filter data to plot        
  for (seslist in 1:2) {
    # Filter data for a specific participant and session
    vas_sub <- df_vas %>% filter(sub == sub_n & ses == seslist)
    fe_sub <- df_fe %>% filter(sub == sub_n & ses == seslist)
    psi_sub <- df_psi %>% filter(sub == sub_n & ses == seslist)
    
    # Set title for the session
    title <- paste(paste('Session', seslist), sep = " ")

    # Plot the session
    plots[[seslist]] <- plotFast_v1(vas_sub, fe_sub, psi_sub, title)
  }
  
  # Generate figure combining plots for session 1 and session 2
  g1 <- ggarrange(plots[[1]], plots[[2]], ncol = 2, nrow = 1) #labels = c("A", "B"),
  g1_with_title <- annotate_figure(g1, top = text_grob(paste("TGI thresholds:", substr), size = 14, face = "bold"))

  # Save figure
  filepath <- here::here('figs', paste0(substr, '.pdf'))
  ggsave(g1_with_title, file = filepath, width = 20, height = 10, dpi = 100, units = "cm")
})
```

