---
title: "Colours based on distance"
author: "Jesper Fischer Ehmsen"
date: '2022-07-24'
output: html_document
---
```{r}
#clear all
rm(list=ls())
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


# Define libraries
```{r, warning=FALSE}
library(readr)
library(stringr)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
```

# Define colors
```{r, warning=FALSE}
reds6  <- brewer.pal(6, "Reds")
blues6 <- brewer.pal(6, "Blues")
purples6 <- brewer.pal(6, "Purples")
greys6 <- brewer.pal(6,"Greys")

```

# Import Multi Thresholding data: responses
Burning choice: yes or no?
Thermal choice: cold or warm?
```{r, warning=FALSE}
# path <- "/mnt/bpp_bids/MultidimThr"
#path <- '/Users/au342995/Downloads/multiThr'
path <- here::here("code","Modeling")
#filename1 <- paste0('sub-', str_pad(sub, 4, pad = "0"), '.csv')

# filenames to import
filename1 <- 'responses.csv'
filename2 <- 'limits.csv' # or psipain 
filename3 <- 'allData.csv'
filename4 <- 'thresholds.csv'

setwd(path) # set working directory

# import files
resp      <- read.csv(file.path(path,filename1))
lims      <- read.csv(file.path(path,filename2))
vas       <- read.csv(file.path(path,filename3))
thr       <- read.csv(file.path(path,filename4))

# define subjects to import
sublist <- lims$id #c(0,10,12,13,14,15,16,18)
```
# Fast TGI: Responses 
Whether the participant perceived burning, cold or warm for each combination of temperatures
```{r, warning=FALSE}
df_resp <- resp
df_resp$coldT <- as.double(df_resp$coldT)
df_resp
```
# Pain threshold data
Pain thresholds measured using the methods of limits
```{r}
df_lims <- lims
df_lims
```

# VAS temperatures and ratings
```{r}
# Get the temperatures that were tested for each participants 
vas_temps <- aggregate(list(coldT = vas$targetTcold, warmT = vas$targetTwarm), by = list(id = vas$SubID, threshold = vas$thresholdProb, level = vas$gainFract, stim = vas$StimType), FUN = mean)
## For myself (Jesper) same as qq = vas %>% group_by(SubID, gainFract,thresholdProb, StimType) %>% summarize(cold = mean(targetTcold), warm = mean(targetTwarm))


# Compute median ratings and response times
vas_ratings <- aggregate(list(vas_median = vas$vasResponse, vasRT_median = vas$vasReactionTime), by = list(id = vas$SubID, threshold = vas$thresholdProb, level = vas$gainFract, stim = vas$StimType, vas = vas$vasType), FUN = median)

#same with median for ratings

# merge vas_temps and was_ratings
df_vas <- merge(vas_temps, vas_ratings, by = c('id', 'threshold', 'level', 'stim'), all = TRUE)


```

# Define threshold function data and restrict data to TGI range (i.e., all data points below CPT and above HPT are defined as NA)
```{r}
df_thr <- data.frame()
for (subN in sublist) {
  lims_sub <- df_lims %>% filter(id == subN) # define CPT and HPT for one participant
  df_sub <- thr %>% filter(id == subN) # define data for each subject (curve)
  df_sub$twarm_25[df_sub$tcold < lims_sub$cpt | df_sub$twarm_25 > lims_sub$hpt] <- NA # remove data below CPT and above HPT
  df_sub$twarm_50[df_sub$tcold < lims_sub$cpt | df_sub$twarm_50 > lims_sub$hpt] <- NA # remove data below CPT and above HPT
  df_sub$twarm_75[df_sub$tcold < lims_sub$cpt | df_sub$twarm_75 > lims_sub$hpt] <- NA # remove data below CPT and above HPT
  df_thr <- rbind(df_thr, df_sub) # concatenate participants data
}
df_thr
```

# Bin data and calculate % of cold and warm responses within each bin (this may need to change!)
```{r}
#perform binning with specific number of bins
df_bin_all <- data.frame()

for (subN in sublist) {
  df_sub <- df_resp %>% filter(id == subN) # define data for each subject
  df_thr1  = df_thr %>% filter(id == subN)
  df_sub$curve = NA
  for (i in 1:nrow(df_sub)){
    index = which(df_thr1[,2] == df_sub[i,3]) #find the cold-temperature that matches between what the subject got and the curve
    d25 = abs(df_thr1[index,3]-df_sub[i,2])
    d50 = abs(df_thr1[index,4]-df_sub[i,2])
    d75 = abs(df_thr1[index,5]-df_sub[i,2])
    
    if(is.na(d25)==T & is.na(d50)==T & is.na(d75)==T){
      next
    }
    if(is.na(d25)==T){
      d25 = 100
    }
    if(is.na(d50)==T){
      d50 = 100
    }
    
    if(is.na(d75)==T){
      d75 = 100
    }
    
    
    if(d25<d50 & d25<d75){
      df_sub[i,6] = 1
    }
    if(d50<d25 & d50<d75){
      df_sub[i,6] = 2
    }
    if(d75<d25 & d75<d50){
      df_sub[i,6] = 3
    }
    }
  df_sub = df_sub %>% filter(curve != 0)
  df_sub$curve = as.factor(df_sub$curve)
  
  
  bins <- df_sub %>% group_by(curve, .drop = FALSE) %>% mutate(bin = cut(coldT, breaks=seq(-1.5, 31.5, by = 3))) %>% ungroup

  bins$bin = as.factor(bins$bin)
  bins$cold_warm = as.factor(bins$cold_warm)
  
  
  #checks if everything is rated as warm or cold:
  if(length(levels(bins$cold_warm)) == 1){
    if(bins$cold_warm[1] == 1){
      levels(bins$cold_warm) = "warm"
      df_bin = bins %>% group_by(bin,curve,cold_warm, .drop = FALSE) %>% summarize(n = n()) %>% tidyr::pivot_wider(names_from = "cold_warm", values_from = n)%>% mutate(cold = 0)
    if(bins$cold_warm[1] == 0){
      levels(bins$cold_warm) = "cold"
      df_bin = bins %>% group_by(bin,curve,cold_warm, .drop = FALSE) %>% summarize(n = n()) %>% tidyr::pivot_wider(names_from = "cold_warm", values_from = n)%>% mutate(warm = 0)
      
    }
    #if not then its cold and warm
  }}else{
    levels(bins$cold_warm) = c("cold","warm")
      df_bin = bins %>% group_by(bin,curve,cold_warm, .drop = FALSE) %>% summarize(n = n()) %>% tidyr::pivot_wider(names_from = "cold_warm", values_from = n)
  
  }
  
  

  

  df_bin$percent_warm_abs <- df_bin$warm/(df_bin$warm + df_bin$cold) # calculate the % of stimuli perceived as warm in each bin
  df_bin$percent_warm_rel <- round(df_bin$percent_warm_abs) # 0 = less than 50% of data points were felt as cold; 1 = more than 50% of data points were perceived as warm
  id <- rep(subN, nrow(df_bin))
  df_bin_sub <- cbind(id, df_bin) 
  df_bin_all <- rbind(df_bin_all, df_bin_sub)
  
  
  

}
df_bin_all = df_bin_all %>% filter(curve != 0)

names(df_bin_all)[1] = "id"





```









# Generate contonous data within each bin
```{r}
# function to generate continuous data points within each bin corresponding to the quality of the perceived sensation (cold or warm)
gen_quality_datapoints <- function(df) {
  df$bin = droplevels(df$bin)

  cold_bin_start = seq(-1.5, 28.5, by = 3)
  cold_bin_end = seq(1.5, 31.5, by = 3)
  warm_bin_start = seq(-1.5, 28.5, by = 3)
  warm_bin_end = seq(1.5, 31.5, by = 3)

  
  id <- unique(df$id)
  df_qual <- data.frame()

  
  

#loop through curves and the bins to make the bins continous.
  for (j in unique(df$curve)){
    curve = df %>% filter(as.numeric(as.character(curve)) == j)
  for (i in 1:length(cold_bin_start)){
    tcold <- seq(cold_bin_start[i], cold_bin_end[i]-0.1, by = 0.1)
    twarm <- seq(warm_bin_start[i], warm_bin_end[i]-0.1, by = 0.1)
    
    w_percent.x <- rep(curve$percent_warm_rel[curve$bin == paste0('(', as.character(cold_bin_start[i]), ',', as.character(cold_bin_end[i]), ']')], times = length(tcold))
    
    w_percent.y <- rep(curve$percent_warm_rel[curve$bin == paste0('(', as.character(warm_bin_start[i]), ',', as.character(warm_bin_end[i]), ']')], times = length(twarm))
    df_temp <- data.frame(id, tcold, w_percent.x, w_percent.y)
    df_temp$curve = j
    df_qual <- rbind(df_qual, df_temp)
  }
  }
  
  
  df_qual <- subset(df_qual, tcold >= 0 & tcold <= 29)
  
return(df_qual)
}


# all participants 
df_qual <- data.frame()
for (subN in sublist) {
  df_bin_sub <- df_bin_all %>% filter(id == subN)
  df_qual_sub <- gen_quality_datapoints(df_bin_sub)
  df_qual <- rbind(df_qual, df_qual_sub)
}
df_qual
```




# merge each subject
```{r}
df_thr_bin <- merge(df_thr, df_qual, by = c('id','tcold'))
df_thr_bin
```


```{r making the threshhold data have colors to make the NAN's being grey}
#making the colours for the curves, red,blue and grey
qq = df_thr_bin %>% mutate(colour = ifelse(w_percent.x == 1 & curve == 1, a<-"red",
                                    ifelse(w_percent.x == 1 & curve == 2, a<-"red",
                                    ifelse(w_percent.x == 1 & curve == 3, a<-"red",
                                    ifelse(w_percent.x == 0 & curve == 1, a<-"blue",
                                    ifelse(w_percent.x == 0 & curve == 2, a<-"blue",
                                    ifelse(w_percent.x == 0 & curve == 3, a<-"blue",
                                           a<-"grey")))))))
qq$colour = ifelse(is.na(qq$colour) == T, a<- "grey",qq$colour)
qq$colour = as.factor(qq$colour)
```


```{r Plot a single participant, just change the number in the square backet ([])}

subN = unique(df_lims$id)[2] # change participant number here!
limits <- df_lims %>% filter(id == subN)


ggplot(df_resp %>% filter(id == subN), mapping = aes(x = coldT, y = warmT)) +
      theme_bw() +
      geom_point(aes(color = as.factor(cold_warm))) + # display tested data points + 
      geom_jitter(aes(color = as.factor(cold_warm)))+
      scale_color_manual(labels = c("Cold", "Warm"), values=c(blues6[3], reds6[3]))+  # update colors: mostly warm = red, mostly cold = blue
      

      # add threshold function for every curve
  
        geom_point(data = qq %>% filter(id == subN & curve == 1 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter(id == subN & curve == 1 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter(id == subN & curve == 1 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = reds6[3]) +

  
      geom_point(data = qq %>% filter(id == subN & curve == 2 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter(id == subN & curve == 2 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter(id == subN & curve == 2 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = reds6[3]) +

  
  
        geom_point(data = qq %>% filter(id == subN & curve == 3 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter(id == subN & curve == 3 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter(id == subN & curve == 3 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = reds6[3]) +

  

      # add vas points that were tested
      geom_point(data = df_vas %>% filter(id == subN & warmT != 30 & coldT !=30), mapping = aes(x = coldT, y = warmT, shape = as.factor(threshold)), size = 2) +

      # add cpt and hpt as dashed lines
      geom_hline(yintercept = limits$hpt, linetype="dashed", color = "red") +
      geom_vline(xintercept = limits$cpt, linetype="dashed", color = "blue") +

      # set axis
      scale_x_continuous(breaks=seq(0,30,by=3)) + # change x axis
      lims(y = c(29,51)) + # change axis limits
      theme(legend.position = "none") # remove legend
    
```

#a plot for all
```{r, fig.height=7.5,fig.width=10}
ggplot(df_resp, mapping = aes(x = coldT, y = warmT)) +
      theme_bw() +
      geom_point(aes(color = as.factor(cold_warm))) + # display tested data points + 
      geom_jitter(aes(color = as.factor(cold_warm)))+
      scale_color_manual(labels = c("Cold", "Warm"), values=c(blues6[3], reds6[3]))+  # update colors: mostly warm = red, mostly cold = blue
          

      # add threshold function for every curve
  
        geom_point(data = qq %>% filter(curve == 1 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter( curve == 1 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter(curve == 1 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_25), size = 0.5, color = reds6[3]) +

  
      geom_point(data = qq %>% filter( curve == 2 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter( curve == 2 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter( curve == 2 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = reds6[3]) +

  
  
        geom_point(data = qq %>% filter( curve == 3 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = greys6[6]) +
  geom_point(data = qq %>% filter( curve == 3 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter( curve == 3 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_75), size = 0.5, color = reds6[3]) +

  

      # add vas points that were tested
      geom_point(data = df_vas %>% filter( warmT != 30 & coldT !=30), mapping = aes(x = coldT, y = warmT, shape = as.factor(threshold)), size = 2) +

      # add cpt and hpt as dashed lines
      geom_hline(data = df_lims, aes(yintercept = hpt), linetype="dashed", color = "red") +
      geom_vline(data = df_lims, aes(xintercept = cpt), linetype="dashed", color = "blue") +

      # set axis
      scale_x_continuous(breaks=seq(0,30,by=3)) + # change x axis
      lims(y = c(29,51)) + # change axis limits
      theme(legend.position = "none") + # remove legend
    facet_wrap(~id,nrow = 3, ncol = 5)
2+2
```




```{r Plotting the 50% threshhold function for all participants, fig.height=7.5, fig.width=10}

ids = qq %>% filter(curve == 2 & as.character(colour) == "grey") %>% group_by(id) %>% summarise(
  label_position_x=mean(tcold,na.rm=T),
  label_position_y=mean(twarm_50,na.rm=T),
  label_value=id
)
ggplot() +
      theme_bw() +
     
      # add threshold function
  geom_point(data = qq %>% filter(curve == 2 & as.character(colour) == "grey"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = greys6[6]) +
#  geom_text(data = ids, aes(x = label_position_x, y = label_position_y,label = label_value))+  
  geom_point(data = qq %>% filter(curve == 2 & as.character(colour) == "blue"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = blues6[3]) +
  geom_point(data = qq %>% filter(curve == 2 & as.character(colour) == "red"), mapping = aes(x = tcold, y = twarm_50), size = 0.5, color = reds6[3]) +
  
  
      # set axis
      scale_x_continuous(name = 'Cold', breaks=seq(0,30,by=5), limits = c(0,31)) + # change x axis
      scale_y_continuous(name = 'Warm', breaks=seq(30,50,by=5), limits = c(29,51)) + # change y axis
      theme(legend.position = 'none') + # remove legend
      ggtitle('Individual 50% Threshold functions')
      

```



# Plot ratings per participant (sanity checks)

```{r}
path <- "/Users/au706606/Library/CloudStorage/OneDrive-Personal/PostDoc/Multidim_Thr/data/Experiment-Part1"
filename <- 'allData.csv'
setwd(path) # set working directory
df <- read.csv(file.path(path,filename))

df_summary <- aggregate(list(vas_median = df$vasResponse, vasRT_median = df$vasReactionTime), by = list(id = df$SubID, threshold = df$thresholdProb, level = df$gainFract, stim = df$StimType, vas = df$vasType), FUN = median)
df_summary$id <- factor(df_summary$id)
df_summary$stim <- factor(df_summary$stim, levels = c("Cold", "Warm", "TGI"))
df_summary$vas <- factor(df_summary$vas, levels = c("Cold", "Warm", "Burn"))
```
# Figure 1: TGI stimuli VAS Ratings
```{r} 
# Define colors
df_summary1 = df_summary %>% filter(id == subN)
reds6  <- brewer.pal(6, "Reds")
blues6 <- brewer.pal(6, "Blues")
purples6 <- brewer.pal(6, "Purples")

p1 <- ggplot(data = df_summary1 %>% filter(stim == 'TGI'), mapping = aes(x = level, y = vas_median, fill = vas)) +
   geom_boxplot(aes(fill = interaction(level,threshold,vas))) +
   geom_point(aes(fill = interaction(level,threshold,vas)), shape = 21, size = 2) +

   # Define additional settings
   labs(title = "", y = "VAS (0-100)", x = "Temperature Levels") +
   ggtitle('TGI stimuli ') +
   theme_classic() +
   scale_x_continuous(breaks=c(0.25,0.50,0.75), labels=c("L25%", "L50%", "L75%")) +
   scale_fill_manual(labels = c("Cold", "Warm", "Burn"), values=c(rep(blues6[3],times=9), rep(reds6[3],9), rep(purples6[5], 9))) +
   facet_wrap(~ interaction(vas,threshold)) +
   theme(legend.position = "none") # remove legend
p1
```